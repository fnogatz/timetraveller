#!/usr/bin/env node

require('console-stamp')(console, 'HH:MM:ss.l')

var spinner = require('char-spinner')
var program = require('commander')

var Model = require('../lib/model')

spinner();

program
  .usage('[options] <id> <csv>')
  .option('--clean', 'Drop the collection first')
  .option('--without-index', 'Import data without creating an index')
  .parse(process.argv)

var id = program.args[1]
var filename = program.args[0]

var options = program

var model = Model.getInstance()
model.connect(function(err) {
  if (err) {
    throw err
  }

  model.getMap(id, function(err, map) {
    if (err) {
      throw err
    }

    if (!map) {
      throw new Error('ID '+id+' doesn\'t exist')
    }

    console.log('Start CSV import for ID '+id)

    map.importCSV(filename, options, function(err) {
      if (err) {
        throw err
      }

      console.log('Finished CSV import for ID '+id)

      model.close()
    })
  })
})
