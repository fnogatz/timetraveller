#!/usr/bin/env node

require('console-stamp')(console, 'HH:MM:ss.l')

var spinner = require('char-spinner')
var program = require('commander')
var uuid = require('node-uuid')
var validator = require('validator')
var slug = require('slug')

var Model = require('../lib/model')

spinner();

program
  .usage('[options] <name>')
  .option('--id <name>', 'Use this ID (default: random uuid)')
  .option('--slug <name>', 'Page slug')
  .parse(process.argv)

var model = Model.getInstance()

var name = program.args[0]
name = validator.trim(name)
name = validator.stripLow(name)

var id = program.id || uuid.v4()
if (!model.isValidId(id)) {
  throw new Error('Database '+id+' is reserved and therefore not allowed')
}

model.connect(function(err) {
  if (err) {
    throw err
  }

  model.createMap(id, {
    name: name,
    slug: program.slug || slug(name)
  }, function(err) {
    if (err) {
      throw err
    }

    console.log('Map created (ID= '+id+')')

    model.close()
  })
})
