#!/usr/bin/env node

require('console-stamp')(console, 'HH:MM:ss.l')

var spinner = require('char-spinner')
var program = require('commander')
var Parser = require('newline-json').Parser

var Model = require('../lib/model')
var parser = new Parser()

spinner();

program
  .usage('<id>')
  .parse(process.argv)

var id = program.args[0]
var model = Model.getInstance()
var map

var datasets = 0
var running = 0
var inputFinished = false

parser.on('data', function(geojson) {
  running++

  map.importGeoJSON(geojson, program, function(err) {
    if (err) {
      //throw err
    } else {
      datasets++

      if (datasets % 100 === 0) {
        console.log(datasets+' datasets imported.')
      }
    }

    running--
    checkForFinish()
  })
})
parser.on('end', function() {
  inputFinished = true
  checkForFinish()
})

process.stdin.on('error', function(err) {
  throw err
})

parser.pause()
process.stdin.pipe(parser)

model.connect(function(err) {
  if (err) {
    throw err
  }

  model.getMap(id, function(err, m) {
    if (err) {
      throw err
    }

    map = m

    if (!map) {
      throw new Error('ID '+id+' doesn\'t exist.')
    }

    console.log('Start import for ID '+id+'.')

    parser.resume()
  })
})

function checkForFinish() {
  if (running === 0 && inputFinished === true) {
    console.log('Finished import of '+datasets+' datasets.')
    process.exit(0)
  }
}
