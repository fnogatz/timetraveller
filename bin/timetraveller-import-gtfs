#!/usr/bin/env node

require('console-stamp')(console, 'HH:MM:ss.l')

var spinner = require('char-spinner')
var program = require('commander')

var Model = require('../lib/model')

spinner();

program
  .usage('[options] <id> <gtfs>')
  .option('--clean', 'Drop the collection first')
  .option('--without-index', 'Import data without creating an index')
  .option('--date <date>', 'Import this date')
  .parse(process.argv)

var id = program.args[0]
var dir = program.args[1]

program.date = program.date || (new Date()).toISOString().slice(0,10)

var model = Model.getInstance()
model.connect(function(err) {
  if (err) {
    throw err
  }

  model.getMap(id, function(err, map) {
    if (err) {
      throw err
    }

    if (!map) {
      throw new Error('ID '+id+' doesn\'t exist')
    }

    console.log('Start GTFS import for ID '+id)

    map.importGTFS(dir, program, function(err) {
      if (err) {
        throw err
      }

      console.log('Finished GTFS import for ID '+id)

      model.close()
    })
  })
})
